# Evaluation Mode Patches for MLOps Overlay - Simplified
#
# This file patches the base Tekton task to support evaluation mode.
# Removes unnecessary validation, checks, and upload steps.
# Assumes XLSX files always come from DVC/S3/MinIO.
#
# EVALUATE_SPECIFIC_NODE can be:
# - "all" - runs normal SAST workflow
# - "filter" - runs only filter evaluation
# - "judge" - runs only judge evaluation
# - "summary" - runs only summary evaluation
# - "all,filter" - runs normal SAST workflow + filter evaluation
#
- op: add
  path: /spec/results/-
  value:
    name: filter-evaluation-results
    description: "JSON evaluation results from filter node"
- op: add
  path: /spec/results/-
  value:
    name: judge-evaluation-results
    description: "JSON evaluation results from judge node"
- op: add
  path: /spec/results/-
  value:
    name: summary-evaluation-results
    description: "JSON evaluation results from summary node"
- op: add
  path: /spec/results/-
  value:
    name: workflow-metrics
    description: "JSON containing workflow metrics (TP/FP/TN/FN, accuracy, precision, recall, F1)"
# Override SERVICE_ACCOUNT_JSON_PATH to prevent Google Sheets authentication attempts
# MLOps evaluation mode always uses XLSX files from DVC/S3/MinIO, never Google Sheets
- op: replace
  path: /spec/steps/5/env/16/value
  value: ""
- op: replace
  path: /spec/steps/5/image
  value: "$(params.CONTAINER_IMAGE)"
- op: replace
  path: /spec/steps/5/script
  value: |
    #!/usr/bin/env sh
    # Export Tekton parameters as environment variables for the script
    export EVALUATE_SPECIFIC_NODE="$(params.EVALUATE_SPECIFIC_NODE)"
    export PROJECT_NAME="$(params.PROJECT_NAME)"
    export PROJECT_VERSION="$(params.PROJECT_VERSION)"

    # Run the evaluation workflow script
    /app/deploy/tekton/scripts/run-evaluation-workflow.sh
- op: add
  path: /spec/steps/7
  value:
    name: write-evaluation-results-mlops
    image: $(params.BASE_IMAGE)
    volumeMounts:
      - name: shared-data
        mountPath: /shared-data
    env:
      - name: PROJECT_VERSION
        value: "$(params.PROJECT_VERSION)"
      - name: TEKTON_RESULTS_DIR
        value: "/tekton/results"
    command: ["/scripts/write_evaluation_results.sh"]
# STEP 9: Upload token metrics to S3/MinIO
- op: add
  path: /spec/steps/8
  value:
    name: upload-token-metrics-to-s3-mlops
    image: $(params.BASE_IMAGE)
    env:
      - name: EVALUATE_SPECIFIC_NODE
        value: "$(params.EVALUATE_SPECIFIC_NODE)"
      - name: S3_OUTPUT_BUCKET_NAME
        value: "$(params.S3_OUTPUT_BUCKET_NAME)"
      - name: PIPELINE_RUN_ID
        value: "$(params.PIPELINE_RUN_ID)"
      - name: PROJECT_NAME
        value: "$(params.PROJECT_NAME)"
      - name: PROJECT_VERSION
        value: "$(params.PROJECT_VERSION)"
      - name: AWS_ACCESS_KEY_ID
        valueFrom:
          secretKeyRef:
            name: sast-ai-s3-output-credentials
            key: access_key_id
      - name: AWS_SECRET_ACCESS_KEY
        valueFrom:
          secretKeyRef:
            name: sast-ai-s3-output-credentials
            key: secret_access_key
      - name: S3_ENDPOINT_URL
        valueFrom:
          secretKeyRef:
            name: sast-ai-s3-output-credentials
            key: endpoint_url
            optional: true
    volumeMounts:
      - name: shared-data
        mountPath: /shared-data
      - name: s3-output-scripts
        mountPath: /scripts/s3-output
    command: ["/scripts/upload_token_metrics_to_s3.sh"]
# STEP 10: Add EVALUATE_SPECIFIC_NODE env var to cleanup step
- op: add
  path: /spec/steps/9/env/-
  value:
    name: EVALUATE_SPECIFIC_NODE
    value: "$(params.EVALUATE_SPECIFIC_NODE)"