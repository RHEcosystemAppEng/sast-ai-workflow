name: Build Release Image

on:
  release:
    types: [published]

env:
  REGISTRY: quay.io
  IMAGE_NAME: quay.io/ecosystem-appeng/sast-ai-workflow

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to update release notes and push branches
      packages: write
      pull-requests: write  # Required to create PRs for version updates

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Quay.io
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.QUAY_USERNAME }}
        password: ${{ secrets.QUAY_PASSWORD }}

    - name: Extract version from tag
      id: version
      run: |
        # Remove 'v' prefix if present (e.g., v1.2.3 -> 1.2.3)
        VERSION=${GITHUB_REF#refs/tags/}
        VERSION=${VERSION#v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Update pyproject.toml with release version
      run: |
        # Update the version in pyproject.toml
        sed -i 's/^version = ".*"/version = "${{ steps.version.outputs.version }}"/' pyproject.toml
        
        # Verify the change
        echo "Updated pyproject.toml version:"
        grep '^version = ' pyproject.toml

    - name: Update production overlay with release version
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        
        # Update prod overlay task patch
        sed -i "s|RELEASE_IMAGE_VERSION_PLACEHOLDER|$VERSION|g" \
          deploy/tekton/overlays/prod/task-patch.yaml
        
        echo "Updated production overlay to version: $VERSION"

    - name: Update ArgoCD application with release version
      run: |
        # Use original tag format for ArgoCD (preserves v prefix if present)
        ORIGINAL_TAG=${GITHUB_REF#refs/tags/}
        
        # Update ArgoCD application with original tag format
        sed -i "s|RELEASE_VERSION_PLACEHOLDER|$ORIGINAL_TAG|g" \
          deploy/argocd/argocd-application-prod.yaml
        
        echo "Updated ArgoCD application to version: $ORIGINAL_TAG"

    - name: Create PR for version updates
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        BRANCH_NAME="release/v${VERSION}-version-update"
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Check if there are changes to commit
        git add pyproject.toml deploy/tekton/overlays/prod/task-patch.yaml deploy/argocd/argocd-application-prod.yaml
        if git diff --staged --quiet; then
          echo "No changes to commit"
          exit 0
        fi
        
        # Create a new branch for the PR
        git checkout -b "$BRANCH_NAME"
        git commit -m "Release v${VERSION}: Update version in production manifests"
        git push origin "$BRANCH_NAME"
        
        # Create a pull request
        gh pr create \
          --title "Release v${VERSION}: Update version in production manifests" \
          --body "This PR was automatically created by the release workflow to update version references.

        ## Changes
        - Updated \`pyproject.toml\` version to \`${VERSION}\`
        - Updated production Tekton overlay to use image tag \`${VERSION}\`
        - Updated ArgoCD application to target release \`v${VERSION}\`

        **Auto-generated by release workflow for tag v${VERSION}**" \
          --base main \
          --head "$BRANCH_NAME"

    - name: Generate container metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.IMAGE_NAME }}
        tags: |
          # Exact release version only (e.g., 1.2.3)
          type=semver,pattern={{version}}
        labels: |
          org.opencontainers.image.title=SAST AI Workflow
          org.opencontainers.image.description=LLM-based tool for SAST vulnerability detection
          org.opencontainers.image.vendor=Red Hat Ecosystem AppEng
          org.opencontainers.image.version=${{ steps.version.outputs.version }}

    - name: Build and push release container
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Containerfile
        platforms: linux/amd64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Generate release artifact summary
      run: |
        echo "## üöÄ Release Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Container Images Published:**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- \`${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Registry:** [Quay.io Repository](https://quay.io/repository/ecosystem-appeng/sast-ai-workflow)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Note:** Production deployments should use this specific version tag." >> $GITHUB_STEP_SUMMARY

    - name: Update release with container info
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const release = await github.rest.repos.getReleaseByTag({
            owner,
            repo,
            tag: context.ref.replace('refs/tags/', '')
          });
          
          const containerInfo = `

          ## üì¶ Container Images

          This release includes the following container image published to Quay.io:

          - \`${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}\`

          ### üê≥ Usage

          \`\`\`bash
          # Pull specific version for production
          podman pull ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
          \`\`\`

          ### üîó Registry
          View all versions: [Quay.io Repository](https://quay.io/repository/ecosystem-appeng/sast-ai-workflow)
          
          **Note:** Production deployments should use this specific version tag.
          `;
          
          await github.rest.repos.updateRelease({
            owner,
            repo,
            release_id: release.data.id,
            body: release.data.body + containerInfo
          });
